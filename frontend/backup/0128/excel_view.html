<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°ˆæ¡ˆç¸¾æ•ˆ - Excel ç·¨è¼¯æ¨¡å¼</title>
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        #data-table { 
            margin-top: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            background-color: white;
            border-radius: 5px;
        }
        /* è®“æœ‰æç¤ºçš„æ¨™é¡Œæ»‘é¼ è®Šæˆå•è™Ÿæ¸¸æ¨™ */
        .tabulator-col-title {
            cursor: help;
        }
        .btn-toolbar { margin-bottom: 15px; }
        
        /* è‡ªå‹•è¨ˆç®—æ¬„ä½çš„èƒŒæ™¯è‰²æç¤º */
        .calc-col { background-color: #e9ecef !important; color: #495057; font-weight: bold; }
        
        /* èª¿æ•´ Tabulator æ¨£å¼ */
        .tabulator .tabulator-header {
            font-weight: bold;
            background-color: #f1f3f5;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center">
        <h3>ğŸ“Š å°ˆæ¡ˆç¸¾æ•ˆç¸½è¡¨ (Excel æ¨¡å¼)</h3>
        <div>
            <button class="btn btn-success" onclick="addNewRow()">â• æ–°å¢ä¸€åˆ—</button>
            <button class="btn btn-primary" onclick="saveData()">ğŸ’¾ å„²å­˜æ‰€æœ‰è³‡æ–™</button>
            <a href="dashboard.html" class="btn btn-outline-secondary ms-2">ğŸ“ˆ å‰å¾€å„€è¡¨æ¿</a>
        </div>
    </div>
    
    <div class="alert alert-warning mt-2 d-flex align-items-center">
        <span class="me-2 fs-4">ğŸ’¡</span>
        <ul class="mb-0 ps-3">
            <li>å°‡æ»‘é¼ ç§»åˆ°æœ‰ <b>(?)</b> çš„æ¨™é¡Œä¸Šæ–¹ï¼Œå¯æŸ¥çœ‹å¡«å¯«èªªæ˜ã€‚</li>
            <li>ç°è‰²åº•çš„æ¬„ä½ç‚º<b>è‡ªå‹•è¨ˆç®—</b>ï¼Œè«‹è¼¸å…¥ç›¸é—œè¯çš„æ•¸å€¼ï¼ˆå¦‚é ä¼°/å¯¦éš›æˆæœ¬ï¼‰ï¼Œç³»çµ±æœƒè‡ªå‹•æ›´æ–°ã€‚</li>
            <li>é‡‘é¡æ¬„ä½æ”¯æ´è¼¸å…¥åƒåˆ†ä½é€—è™Ÿï¼ˆä¾‹å¦‚ï¼š120,000ï¼‰ã€‚</li>
        </ul>
    </div>
    
    <div id="msg" class="alert alert-info mt-2" style="display:none;"></div>

    <div id="data-table"></div>
</div>

<script>
    // æ¡ˆä»¶é¡å‹æ¸…å–®
    const caseTypes = [
        "è¨­å‚™äº¤ä»˜-å„²èƒ½", "è¨­å‚™äº¤ä»˜-å…¶ä»–", "ç¯€èƒ½æ”¹å–„", "ç¯€æ°´",
        "é¡§å•-ISO14064", "é¡§å•-ISO14067", "é¡§å•-ISO50001", "é¡§å•-å…¶ä»–"
    ];

    // --- 1. å®šç¾©æ¬„ä½ (A~AE) ---
    // æ³¨æ„ï¼šé‡‘é¡è¼¸å…¥æ¬„ä½æ”¹ç‚º "input" ç·¨è¼¯å™¨ï¼Œä»¥å®¹è¨±ä½¿ç”¨è€…è¼¸å…¥é€—è™Ÿ
    const tableColumns = [
        {title:"A. Project Def", field:"project_def", editor:"input", width:150, frozen:true}, 
        {title:"B. å¹´åº¦", field:"year", editor:"number", width:80},
        {title:"C. å°ˆæ¡ˆåç¨±", field:"project_name", editor:"input", width:200},
        {title:"D. æ¡ˆä»¶é¡å‹", field:"case_type", editor:"list", editorParams:{values:caseTypes}, width:150},
        
        // --- æ—¥æœŸ (è¼¸å…¥æ ¼å¼éœ€ç‚º YYYY-MM-DD æˆ– YYYY/MM/DD) ---
        {
            title:"E. é–‹å·¥æ—¥ (?)", field:"start_date", editor:"input", 
            headerTooltip:"ä¾PJM Project Progress Weeklyçš„é–‹å·¥æ—¥ç‚ºæº–\næ ¼å¼ï¼šYYYY-MM-DD"
        },
        {
            title:"F. å¯¦éš›å®Œå·¥ (?)", field:"act_end_date", editor:"input",
            headerTooltip:"ä¾PJM Project Mangement å» å•†é©—æ”¶é€²åº¦ä¹‹å®Œæˆé©—æ”¶æ—¥æœŸç‚ºæº–"
        },
        {
            title:"G. é è¨ˆå®Œå·¥ (?)", field:"est_end_date", editor:"input",
            headerTooltip:"ä¾åˆç´„ä¹‹å®Œå·¥æ—¥ç‚ºæº–"
        },
        
        // --- è‡ªå‹•è¨ˆç®—å¤©æ•¸ (ç¦æ­¢ç·¨è¼¯) ---
        {title:"H. å¯¦éš›æ—¥æ•¸ (è‡ªå‹•)", field:"act_days", editor:false, cssClass:"calc-col"},
        {title:"I. é ä¼°æ—¥æ•¸ (è‡ªå‹•)", field:"est_days", editor:false, cssClass:"calc-col"},
        
        // --- æˆæœ¬èˆ‡å„ªåŒ– ---
        {
            title:"J. å¯¦éš›äººåŠ›$ (?)", field:"act_labor_cost", editor:"input", 
            headerTooltip:"ä»¥PSç³»çµ±å¯¦éš›äººåŠ›æˆæœ¬ç‚ºæº–",
            formatter:"money", formatterParams:{precision:0}
        },
        {
            title:"K. é ä¼°äººåŠ›$ (?)", field:"est_labor_cost", editor:"input", 
            headerTooltip:"ä¾ç…§æˆæœ¬æ”¶é›†è¡¨Internal (PS01)ç‚ºæº–",
            formatter:"money", formatterParams:{precision:0}
        },
        
        // è‡ªå‹•è¨ˆç®—
        {title:"L. ç¯€çœäººåŠ›$ (è‡ªå‹•)", field:"saved_labor_cost", editor:false, formatter:"money", formatterParams:{precision:0}, cssClass:"calc-col text-success"}, 
        {title:"M. äººåŠ›å„ªåŒ–% (è‡ªå‹•)", field:"labor_opt_rate", editor:false, formatter:"money", formatterParams:{symbol:"%", precision:2}, cssClass:"calc-col"},
        
        {
            title:"N. é ä¼°ç®¡ç†$ (?)", field:"est_mgmt_cost", editor:"input",
            headerTooltip:"ä¾PSç³»çµ±ä¹‹CJE0ç‚ºæº–ï¼Œéœ€è‡ªè¡ŒåŠ ç¸½Plan costs çš„Travelling/Insurance",
            formatter:"money", formatterParams:{precision:0}
        },
        {
            title:"O. å¯¦éš›ç®¡ç†$ (?)", field:"act_mgmt_cost", editor:"input",
            headerTooltip:"ä¾PSç³»çµ±ä¹‹CJE0ç‚ºæº–ï¼Œéœ€è‡ªè¡ŒåŠ ç¸½Act.costs çš„Travelling/Insurance",
            formatter:"money", formatterParams:{precision:0}
        },
        
        // è‡ªå‹•è¨ˆç®— (é ä¼°ç®¡ç† - å¯¦éš›ç®¡ç†)
        {title:"P. ç¯€çœç®¡ç†$ (è‡ªå‹•)", field:"saved_mgmt_cost", editor:false, formatter:"money", formatterParams:{precision:0}, cssClass:"calc-col text-success"},
        
        {
            title:"Q. Plan costs (?)", field:"plan_costs", editor:"input", 
            headerTooltip:"ä¾PSç³»çµ±ä¹‹CJE0ç‚ºæº–",
            formatter:"money", formatterParams:{precision:0}
        },
        {
            title:"R. Act. costs (?)", field:"act_costs", editor:"input", 
            headerTooltip:"ä¾PSç³»çµ±ä¹‹CJE0ç‚ºæº–",
            formatter:"money", formatterParams:{precision:0}
        },
        
        // è‡ªå‹•è¨ˆç®— ((Plan - Act) / Plan)
        {title:"S. åˆ©æ½¤å„ªåŒ–% (è‡ªå‹•)", field:"profit_opt_rate", editor:false, formatter:"money", formatterParams:{symbol:"%", precision:2}, cssClass:"calc-col"},
        
        // --- ç’°å¢ƒ ---
        {
            title:"T. é ä¼°æ¸›ç¢³ (?)", field:"est_carbon_save", editor:"number",
            headerTooltip:"1.ä¾å°ˆæ¡ˆå€‹åˆ¥è¨ˆç®— (é‡æ¸¬é©—è­‰/éŠ˜ç‰Œæ•ˆç‡)\n2.ä¾ç¯€é›»é‡*é›»åŠ›ç¢³æ’ä¿‚æ•¸"
        },
        {
            title:"U. é ä¼°ç¯€é›» (?)", field:"est_elec_save", editor:"number",
            headerTooltip:"ä¾å°ˆæ¡ˆå€‹åˆ¥è¨ˆç®— (é‡æ¸¬é©—è­‰/éŠ˜ç‰Œæ•ˆç‡)"
        },
        {
            title:"V. é ä¼°é›»è²»çœ (?)", field:"est_elec_bill_save", editor:"number",
            headerTooltip:"1.ä¾è¨ˆåŠƒæ›¸ç´€è¼‰ä¹‹é›»è²»*ç¯€é›»é‡(kWh/yr)\n2.ä¾é›»è²»å–®ä¹‹é›»è²»*ç¯€é›»é‡(kWh/yr)"
        },
        
        {
            title:"W. å¯¦éš›æ¸›ç¢³ (?)", field:"act_carbon_save", editor:"number",
            headerTooltip:"1.ä¾å°ˆæ¡ˆå€‹åˆ¥è¨ˆç®— (é‡æ¸¬é©—è­‰/éŠ˜ç‰Œæ•ˆç‡)\n2.ä¾ç¯€é›»é‡*é›»åŠ›ç¢³æ’ä¿‚æ•¸"
        },
        {
            title:"X. å¯¦éš›ç¯€é›» (?)", field:"act_elec_save", editor:"number",
            headerTooltip:"ä¾å°ˆæ¡ˆå€‹åˆ¥è¨ˆç®— (é‡æ¸¬é©—è­‰/éŠ˜ç‰Œæ•ˆç‡)"
        },
        {
            title:"Y. å¯¦éš›é›»è²»çœ (?)", field:"act_elec_bill_save", editor:"number",
            headerTooltip:"1.ä¾è¨ˆåŠƒæ›¸ç´€è¼‰ä¹‹é›»è²»*ç¯€é›»é‡(kWh/yr)\n2.ä¾é›»è²»å–®ä¹‹é›»è²»*ç¯€é›»é‡(kWh/yr)"
        },
        
        {
            title:"Z. é ä¼°ç¯€æ°´ (?)", field:"est_water_save", editor:"number",
            headerTooltip:"ä¾å°ˆæ¡ˆå€‹åˆ¥è¨ˆç®—"
        },
        {
            title:"AA. å¯¦éš›ç¯€æ°´ (?)", field:"act_water_save", editor:"number",
            headerTooltip:"ä¾å°ˆæ¡ˆå€‹åˆ¥è¨ˆç®—"
        },
        
        // --- ç¢³æ¬Š ---
        {
            title:"AB. é ä¼°ç¢³æ¬Šé¡ (?)", field:"est_carbon_credit", editor:"number",
            headerTooltip:"ä¾æ ¸å¯é¡åº¦å¡«å¯«"
        },
        {
            title:"AC. å¯¦éš›ç¢³æ¬Šé¡ (?)", field:"act_carbon_credit", editor:"number",
            headerTooltip:"ä¾æ ¸å¯é¡åº¦å¡«å¯«"
        },
        {
            title:"AD. é ä¼°ç¢³æ¬Šåƒ¹ (?)", field:"est_carbon_value", editor:"number",
            headerTooltip:"ä¾å¹³å°å–®åƒ¹*æ ¸å¯é¡åº¦è¨ˆç®—"
        },
        {
            title:"AE. å¯¦éš›ç¢³æ¬Šåƒ¹ (?)", field:"act_carbon_price", editor:"number",
            headerTooltip:"ä¾å¹³å°å–®åƒ¹*æ ¸å¯é¡åº¦è¨ˆç®—"
        }
    ];

    // --- 2. æ ¸å¿ƒé‹ç®—é‚è¼¯ (å¢å¼·ç‰ˆ) ---
    function recalcRow(rowData) {
        // â˜… è½‰æ•¸å­—å‡½å¼ï¼šç§»é™¤é€—è™Ÿä¸¦è½‰ç‚º Float
        const val = (v) => {
            if (!v) return 0;
            let cleanStr = String(v).replace(/,/g, '').trim();
            return parseFloat(cleanStr) || 0;
        };
        
        // â˜… æ—¥æœŸè¨ˆç®—å‡½å¼ï¼šç›¸å®¹ / æˆ– -
        const calcDays = (start, end) => {
            if (!start || !end) return 0;
            // å˜—è©¦è§£ææ—¥æœŸï¼Œå¦‚æœå¤±æ•—å‰‡æ›¿æ›æ ¼å¼
            let d1 = new Date(start);
            let d2 = new Date(end);
            
            if (isNaN(d1.getTime())) d1 = new Date(String(start).replace(/\//g, '-'));
            if (isNaN(d2.getTime())) d2 = new Date(String(end).replace(/\//g, '-'));

            if (isNaN(d1.getTime()) || isNaN(d2.getTime())) return 0;
            
            let diffTime = d2 - d1;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        };

        // === å…¬å¼é‹ç®— ===

        // H. å¯¦éš›æ–½ä½œæ—¥æ•¸ = F - E
        rowData.act_days = calcDays(rowData.start_date, rowData.act_end_date);

        // I. é ä¼°æ–½ä½œæ—¥æ•¸ = G - E
        rowData.est_days = calcDays(rowData.start_date, rowData.est_end_date);

        // L. ç¯€çœäººåŠ›æˆæœ¬ = K(é ä¼°) - J(å¯¦éš›)
        rowData.saved_labor_cost = val(rowData.est_labor_cost) - val(rowData.act_labor_cost);

        // M. ç®¡ç†è²»ç”¨ç‡å„ªåŒ– = (L / K)
        if (val(rowData.est_labor_cost) !== 0) {
            rowData.labor_opt_rate = (val(rowData.saved_labor_cost) / val(rowData.est_labor_cost)) * 100;
        } else {
            rowData.labor_opt_rate = 0;
        }

        // P. ç¯€çœç®¡ç†æˆæœ¬ = N(é ä¼°) - O(å¯¦éš›)
        rowData.saved_mgmt_cost = val(rowData.est_mgmt_cost) - val(rowData.act_mgmt_cost);

        // S. åˆ©æ½¤ç‡å„ªåŒ– = (Plan(Q) - Act(R)) / Plan(Q)
        if (val(rowData.plan_costs) !== 0) {
            rowData.profit_opt_rate = ((val(rowData.plan_costs) - val(rowData.act_costs)) / val(rowData.plan_costs)) * 100;
        } else {
            rowData.profit_opt_rate = 0;
        }

        return rowData;
    }

    // --- 3. åˆå§‹åŒ–è¡¨æ ¼ ---
    var table = new Tabulator("#data-table", {
        height: "650px", 
        layout: "fitData", 
        columns: tableColumns,
        reactiveData: true, 
        data: [],
        
        // ç›£è½ï¼šç•¶ä½¿ç”¨è€…ç·¨è¼¯ä»»ä½•ä¸€æ ¼æ™‚ï¼Œè§¸ç™¼é‡ç®—
        cellEdited: function(cell) {
            var row = cell.getRow();
            var rowData = row.getData();
            var newData = recalcRow(rowData);
            row.update(newData);
        }
    });

    // è¼‰å…¥è³‡æ–™
    async function loadData() {
        const msgDiv = document.getElementById('msg');
        try {
            const response = await fetch('http://127.0.0.1:8000/get_projects');
            if (!response.ok) throw new Error("å¾Œç«¯å›æ‡‰éŒ¯èª¤");
            
            const data = await response.json();
            
            // â˜… å¼·åˆ¶é‹ç®—ï¼šè¼‰å…¥æ™‚å°æ¯ç­†è³‡æ–™åŸ·è¡Œ recalcRowï¼Œç¢ºä¿è¨ˆç®—æ¬„ä½æœ‰å€¼
            const calculatedData = data.map(item => recalcRow(item));
            
            table.setData(calculatedData);
        } catch (error) {
            console.error("è¼‰å…¥å¤±æ•—", error);
            msgDiv.className = 'alert alert-danger';
            msgDiv.innerText = "âŒ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹ç¢ºèªå¾Œç«¯ä¼ºæœå™¨ (main.py) æ˜¯å¦å·²å•Ÿå‹•ã€‚";
            msgDiv.style.display = 'block';
        }
    }

    // æ–°å¢ä¸€åˆ—
    function addNewRow() {
        const today = new Date().toISOString().split('T')[0];
        table.addRow({ 
            year: 2024, 
            case_type: "ç¯€èƒ½æ”¹å–„",
            start_date: today,
            act_labor_cost: 0,
            est_labor_cost: 0,
            plan_costs: 0,
            est_mgmt_cost: 0,
            act_mgmt_cost: 0
        }); 
        // æ²å‹•åˆ°åº•éƒ¨
        setTimeout(() => table.scrollToRow(table.getRows()[table.getRows().length - 1], "bottom", true), 100);
    }

    // å„²å­˜è³‡æ–™
    async function saveData() {
        const rows = table.getRows();
        // å„²å­˜å‰ç¢ºä¿è³‡æ–™éƒ½æ˜¯ç¶“éé‹ç®—çš„æœ€æ–°ç‹€æ…‹
        const tableData = rows.map(row => recalcRow(row.getData()));

        const msgDiv = document.getElementById('msg');
        msgDiv.style.display = 'block';
        msgDiv.className = 'alert alert-info';
        msgDiv.innerText = 'å„²å­˜ä¸­...';

        try {
            const response = await fetch('http://127.0.0.1:8000/save_all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(tableData)
            });

            if (response.ok) {
                msgDiv.className = 'alert alert-success';
                msgDiv.innerText = 'âœ… æ‰€æœ‰è³‡æ–™å·²æˆåŠŸå„²å­˜ï¼';
                setTimeout(() => { msgDiv.style.display = 'none'; }, 2000);
            } else {
                throw new Error('å„²å­˜å¤±æ•—');
            }
        } catch (error) {
            msgDiv.className = 'alert alert-danger';
            msgDiv.innerText = 'âŒ å„²å­˜å¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯å·²é–‹å•Ÿ';
        }
    }

    // å•Ÿå‹•æ™‚è¼‰å…¥
    loadData();

</script>
</body>
</html>