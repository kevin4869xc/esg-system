<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°ˆæ¡ˆç¸¾æ•ˆå„€è¡¨æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { background-color: #f4f6f9; padding: 20px; }
        .card { margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: none; }
        .card-header { background-color: white; border-bottom: 2px solid #f0f0f0; font-weight: bold; color: #555; }
        .metric-value { font-size: 1.5rem; font-weight: bold; color: #28a745; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 500; }
        .progress { height: 25px; margin-bottom: 15px; border-radius: 12px; }
        
        .total-mode-badge {
            background-color: #ffc107; color: #333; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; vertical-align: middle; display: none;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center gap-2">
            <h2>ğŸ“Š å°ˆæ¡ˆç¸¾æ•ˆå¯è¦–åŒ–å„€è¡¨æ¿</h2>
            <span id="totalBadge" class="total-mode-badge">ğŸ† å¹´åº¦ç¸½è¦½æ¨¡å¼</span>
        </div>
        
        <div class="d-flex gap-2 align-items-center">
            <span class="fw-bold text-muted">ç¯©é¸:</span>
            
            <select id="yearSelector" class="form-select" style="width: 150px;" onchange="filterProjectsByYear()">
                <option value="ALL">ğŸ“… æ‰€æœ‰å¹´ä»½</option>
                </select>

            <select id="projectSelector" class="form-select" style="width: 350px;" onchange="updateDashboard()">
                </select>
            
            <a href="excel_view.html" class="btn btn-outline-primary">âœï¸ å›åˆ°ç·¨è¼¯è¡¨æ ¼</a>
        </div>
    </div>

    <h4 class="mb-3 text-primary border-bottom pb-2">å£¹ã€åŸ·è¡Œç¸¾æ•ˆ</h4>
    <div class="row">
        <div class="col-md-4">
            <div class="card p-3 h-100">
                <div class="card-header">ä¸€ã€äººåŠ›æˆæœ¬åˆ†æ</div>
                <div class="card-body">
                    <canvas id="laborChart"></canvas>
                    <div class="mt-3 text-center">
                        <small class="text-muted">ç¸½ç¯€çœäººåŠ›æˆæœ¬</small>
                        <div class="metric-value" id="val_saved_labor">$0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card p-3 h-100">
                <div class="card-header">äºŒã€ç®¡ç†æˆæœ¬åˆ†æ</div>
                <div class="card-body">
                    <canvas id="mgmtChart"></canvas>
                    <div class="mt-3 text-center">
                        <small class="text-muted">ç¸½ç¯€çœç®¡ç†æˆæœ¬</small>
                        <div class="metric-value" id="val_saved_mgmt">$0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3 h-100">
                <div class="card-header">ä¸‰ã€æ–½ä½œå·¥æœŸåˆ†æ</div>
                <div class="card-body">
                    <canvas id="daysChart"></canvas>
                    <div class="mt-3 text-center">
                        <small class="text-muted">ç´¯è¨ˆæå‰å®Œå·¥æ—¥æ•¸</small>
                        <div class="metric-value" id="val_saved_days">0 å¤©</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-md-6">
            <div class="card p-3">
                <div class="card-header">å››ã€æ•´é«”ç®¡ç†è²»ç”¨ç‡å„ªåŒ–</div>
                <div class="card-body d-flex justify-content-center">
                    <div style="width: 250px;">
                        <canvas id="mgmtRateChart"></canvas>
                    </div>
                </div>
                <div class="text-center mt-2 text-muted small">
                    è¨ˆç®—å…¬å¼ï¼šç¸½ç¯€çœäººåŠ› / ç¸½é ä¼°äººåŠ›
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card p-3">
                <div class="card-header">äº”ã€æ•´é«”åˆ©æ½¤ç‡å„ªåŒ–</div>
                <div class="card-body d-flex justify-content-center">
                    <div style="width: 250px;">
                        <canvas id="profitRateChart"></canvas>
                    </div>
                </div>
                <div class="text-center mt-2 text-muted small">
                    è¨ˆç®—å…¬å¼ï¼š(ç¸½Plan - ç¸½Act) / ç¸½Plan
                </div>
            </div>
        </div>
    </div>

    <h4 class="mb-3 mt-4 text-success border-bottom pb-2">è²³ã€ç’°å¢ƒè²¢ç»èˆ‡ç¢³æ¬Šç¸¾æ•ˆ</h4>
    <div class="row">
        <div class="col-12">
            <div class="card p-4">
                
                <div class="progress-label">
                    <span>ğŸŒ ç¸½æ¸›ç¢³é‡ (Ton CO2e)</span>
                    <span id="txt_carbon">0 / 0</span>
                </div>
                <div class="progress">
                    <div id="bar_carbon" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                </div>

                <div class="progress-label">
                    <span>âš¡ ç¸½ç¯€é›»é‡ (kWh)</span>
                    <span id="txt_elec">0 / 0</span>
                </div>
                <div class="progress">
                    <div id="bar_elec" class="progress-bar bg-warning text-dark" role="progressbar" style="width: 0%"></div>
                </div>

                <div class="progress-label">
                    <span>ğŸ’° ç¸½ç¯€çœé›»è²» (NTD)</span>
                    <span id="txt_elec_bill">0 / 0</span>
                </div>
                <div class="progress">
                    <div id="bar_elec_bill" class="progress-bar bg-info text-dark" role="progressbar" style="width: 0%"></div>
                </div>

                <div class="progress-label">
                    <span>ğŸ’§ ç¸½ç¯€æ°´é‡ (Ton)</span>
                    <span id="txt_water">0 / 0</span>
                </div>
                <div class="progress">
                    <div id="bar_water" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                </div>

                <hr>

                <div class="progress-label">
                    <span>ğŸ“œ ç¸½ç¢³æ¬Šé¡åº¦ (Ton)</span>
                    <span id="txt_credit_amt">0 / 0</span>
                </div>
                <div class="progress">
                    <div id="bar_credit_amt" class="progress-bar bg-secondary" role="progressbar" style="width: 0%"></div>
                </div>

                <div class="progress-label">
                    <span>ğŸ’ ç¸½ç¢³æ¬Šåƒ¹å€¼ (NTD)</span>
                    <span id="txt_credit_price">0 / 0</span>
                </div>
                <div class="progress">
                    <div id="bar_credit_price" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);

    let allProjects = [];      // å­˜æ”¾æ‰€æœ‰å¾å¾Œç«¯æŠ“ä¾†çš„è³‡æ–™
    let currentProjects = [];  // å­˜æ”¾ç›®å‰ã€Œå¹´ä»½ç¯©é¸å¾Œã€çš„è³‡æ–™
    let charts = {}; 

    // åˆå§‹åŒ–
    async function init() {
        try {
            const response = await fetch('http://127.0.0.1:8000/get_projects');
            allProjects = await response.json();
            
            // 1. åˆå§‹åŒ–å¹´ä»½é¸å–®
            initYearSelector();
            
            // 2. å»ºç«‹åœ–è¡¨å¯¦ä¾‹
            createCharts();
            
            // 3. é è¨­é¡¯ç¤ºæ‰€æœ‰å¹´ä»½çš„ç¸½ç¸¾æ•ˆ
            filterProjectsByYear();

        } catch (error) {
            console.error("ç„¡æ³•é€£ç·šåˆ°å¾Œç«¯", error);
        }
    }

    // --- æ–°å¢åŠŸèƒ½ï¼šåˆå§‹åŒ–å¹´ä»½é¸å–® ---
    function initYearSelector() {
        const yearSet = new Set();
        allProjects.forEach(p => {
            if(p.year) yearSet.add(p.year);
        });

        // å°‡å¹´ä»½æ’åº (ç”±å¤§åˆ°å°ï¼Œä¾‹å¦‚ 2025, 2024...)
        const sortedYears = Array.from(yearSet).sort((a, b) => b - a);

        const yearSelector = document.getElementById('yearSelector');
        sortedYears.forEach(year => {
            const opt = document.createElement('option');
            opt.value = year;
            opt.text = `${year} å¹´`;
            yearSelector.add(opt);
        });
    }

    // --- æ–°å¢åŠŸèƒ½ï¼šç•¶å¹´ä»½æ”¹è®Šæ™‚ï¼Œç¯©é¸å°ˆæ¡ˆåˆ—è¡¨ ---
    function filterProjectsByYear() {
        const selectedYear = document.getElementById('yearSelector').value;
        const projectSelector = document.getElementById('projectSelector');
        
        // 1. ç¯©é¸è³‡æ–™
        if (selectedYear === "ALL") {
            currentProjects = allProjects;
        } else {
            currentProjects = allProjects.filter(p => p.year == selectedYear);
        }

        // 2. é‡å»ºå°ˆæ¡ˆé¸å–®
        projectSelector.innerHTML = '';
        
        // åŠ å…¥ "ç¸½ç¸¾æ•ˆ" é¸é …
        const totalOpt = document.createElement('option');
        totalOpt.value = "TOTAL";
        if (selectedYear === "ALL") {
            totalOpt.text = "ğŸ† æ‰€æœ‰å¹´ä»½ç¸½ç¸¾æ•ˆ";
        } else {
            totalOpt.text = `ğŸ† ${selectedYear} å¹´åº¦ç¸½ç¸¾æ•ˆ`;
        }
        projectSelector.add(totalOpt);

        // åŠ å…¥ "å€‹åˆ¥å°ˆæ¡ˆ" é¸é …
        currentProjects.forEach((p, index) => {
            const opt = document.createElement('option');
            opt.value = index; // é€™è£¡çš„ index æ˜¯å°æ‡‰ currentProjects çš„ç´¢å¼•
            opt.text = `${p.project_name} (${p.project_def})`;
            projectSelector.add(opt);
        });

        // 3. æ›´æ–°å„€è¡¨æ¿ (é è¨­é¸ä¸­ç¸½ç¸¾æ•ˆ)
        updateDashboard();
    }

    // æ›´æ–° Dashboard æ ¸å¿ƒé‚è¼¯
    function updateDashboard() {
        const selector = document.getElementById('projectSelector');
        const selectedValue = selector.value; // "TOTAL" æˆ– index
        const badge = document.getElementById('totalBadge');
        const yearText = document.getElementById('yearSelector').options[document.getElementById('yearSelector').selectedIndex].text;
        
        let p = {}; 

        if (selectedValue === "TOTAL") {
            // --- åŠ ç¸½æ¨¡å¼ ---
            badge.style.display = 'inline-block';
            badge.innerText = `ğŸ† ${yearText} ç¸½è¦½æ¨¡å¼`; // å‹•æ…‹æ”¹è®Šæ¨™ç±¤æ–‡å­—
            p = calculateTotal(currentProjects); // åªåŠ ç¸½ç›®å‰ç¯©é¸å‡ºçš„å¹´ä»½
        } else {
            // --- å–®ä¸€å°ˆæ¡ˆæ¨¡å¼ ---
            badge.style.display = 'none';
            p = currentProjects[selectedValue]; // æŠ“å– currentProjects è£¡çš„è³‡æ–™
            
            // è£œç®—å¤©æ•¸
            p.act_days = calcDays(p.start_date, p.act_end_date);
            p.est_days = calcDays(p.start_date, p.est_end_date);
        }

        renderData(p);
    }

    // å»ºç«‹åœ–è¡¨ (æ¨£å¼è¨­å®š)
    function createCharts() {
        const commonOptions = {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                datalabels: {
                    anchor: 'end', align: 'top', font: { weight: 'bold' },
                    formatter: (value) => Math.round(value).toLocaleString()
                }
            },
            scales: { y: { beginAtZero: true } }
        };

        charts.labor = new Chart(document.getElementById('laborChart'), {
            type: 'bar',
            data: { labels: ['é ä¼°äººåŠ›', 'å¯¦éš›äººåŠ›'], datasets: [{ label: 'é‡‘é¡ ($)', data: [0, 0], backgroundColor: ['#6c757d', '#007bff'] }] },
            options: commonOptions
        });

        charts.mgmt = new Chart(document.getElementById('mgmtChart'), {
            type: 'bar',
            data: { labels: ['é ä¼°ç®¡ç†', 'å¯¦éš›ç®¡ç†'], datasets: [{ label: 'é‡‘é¡ ($)', data: [0, 0], backgroundColor: ['#6c757d', '#17a2b8'] }] },
            options: commonOptions
        });

        charts.days = new Chart(document.getElementById('daysChart'), {
            type: 'bar',
            data: { labels: ['é ä¼°æ—¥æ•¸', 'å¯¦éš›æ—¥æ•¸'], datasets: [{ label: 'å¤©æ•¸', data: [0, 0], backgroundColor: ['#ffc107', '#28a745'] }] },
            options: commonOptions
        });

        charts.mgmtRate = new Chart(document.getElementById('mgmtRateChart'), {
            type: 'doughnut',
            data: { labels: ['å„ªåŒ–æ¯”ä¾‹', 'å…¶ä»–'], datasets: [{ data: [0, 100], backgroundColor: ['#28a745', '#e9ecef'] }] },
            options: { plugins: { datalabels: { display: false } } }
        });

        charts.profitRate = new Chart(document.getElementById('profitRateChart'), {
            type: 'doughnut',
            data: { labels: ['å„ªåŒ–æ¯”ä¾‹', 'å…¶ä»–'], datasets: [{ data: [0, 100], backgroundColor: ['#dc3545', '#e9ecef'] }] },
            options: { plugins: { datalabels: { display: false } } }
        });
    }

    // è¼”åŠ©ï¼šåŠ ç¸½é‚è¼¯
    function calculateTotal(projects) {
        let total = {
            est_labor_cost: 0, act_labor_cost: 0,
            est_mgmt_cost: 0, act_mgmt_cost: 0,
            est_days: 0, act_days: 0,
            plan_costs: 0, act_costs: 0,
            est_carbon_save: 0, act_carbon_save: 0,
            est_elec_save: 0, act_elec_save: 0,
            est_elec_bill_save: 0, act_elec_bill_save: 0,
            est_water_save: 0, act_water_save: 0,
            est_carbon_credit: 0, act_carbon_credit: 0,
            est_carbon_value: 0, act_carbon_price: 0
        };

        const val = (v) => parseFloat(v) || 0;

        projects.forEach(proj => {
            total.est_labor_cost += val(proj.est_labor_cost);
            total.act_labor_cost += val(proj.act_labor_cost);
            total.est_mgmt_cost += val(proj.est_mgmt_cost);
            total.act_mgmt_cost += val(proj.act_mgmt_cost);
            
            total.est_days += calcDays(proj.start_date, proj.est_end_date);
            total.act_days += calcDays(proj.start_date, proj.act_end_date);

            total.plan_costs += val(proj.plan_costs);
            total.act_costs += val(proj.act_costs);

            total.est_carbon_save += val(proj.est_carbon_save);
            total.act_carbon_save += val(proj.act_carbon_save);
            total.est_elec_save += val(proj.est_elec_save);
            total.act_elec_save += val(proj.act_elec_save);
            total.est_elec_bill_save += val(proj.est_elec_bill_save);
            total.act_elec_bill_save += val(proj.act_elec_bill_save);
            total.est_water_save += val(proj.est_water_save);
            total.act_water_save += val(proj.act_water_save);
            
            total.est_carbon_credit += val(proj.est_carbon_credit);
            total.act_carbon_credit += val(proj.act_carbon_credit);
            total.est_carbon_value += val(proj.est_carbon_value);
            total.act_carbon_price += val(proj.act_carbon_price);
        });

        return total;
    }

    // è¼”åŠ©ï¼šç®—å¤©æ•¸
    function calcDays(start, end) {
        if (!start || !end) return 0;
        const d1 = new Date(start);
        const d2 = new Date(end);
        if (isNaN(d1) || isNaN(d2)) return 0;
        return (d2 - d1) / (1000 * 60 * 60 * 24);
    }

    // æ¸²æŸ“è³‡æ–™
    function renderData(p) {
        const val = (v) => parseFloat(v) || 0;

        const savedLabor = val(p.est_labor_cost) - val(p.act_labor_cost);
        const savedMgmt = val(p.est_mgmt_cost) - val(p.act_mgmt_cost);
        const savedDays = val(p.est_days) - val(p.act_days);

        // æ–‡å­—
        document.getElementById('val_saved_labor').innerText = `$${savedLabor.toLocaleString()}`;
        document.getElementById('val_saved_mgmt').innerText = `$${savedMgmt.toLocaleString()}`;
        document.getElementById('val_saved_days').innerText = `${Math.max(0, savedDays)} å¤©`;

        // æŸ±ç‹€åœ–
        updateChart(charts.labor, [val(p.est_labor_cost), val(p.act_labor_cost)]);
        updateChart(charts.mgmt, [val(p.est_mgmt_cost), val(p.act_mgmt_cost)]);
        updateChart(charts.days, [val(p.est_days), val(p.act_days)]);

        // åœ“é¤…åœ–
        let laborOptRate = 0;
        if (val(p.est_labor_cost) !== 0) laborOptRate = (savedLabor / val(p.est_labor_cost)) * 100;
        updatePie(charts.mgmtRate, laborOptRate);

        let profitOptRate = 0;
        if (val(p.plan_costs) !== 0) profitOptRate = ((val(p.plan_costs) - val(p.act_costs)) / val(p.plan_costs)) * 100;
        updatePie(charts.profitRate, profitOptRate);

        // é€²åº¦æ¢
        setProgressBar('bar_carbon', 'txt_carbon', p.act_carbon_save, p.est_carbon_save, 'Ton');
        setProgressBar('bar_elec', 'txt_elec', p.act_elec_save, p.est_elec_save, 'kWh');
        setProgressBar('bar_elec_bill', 'txt_elec_bill', p.act_elec_bill_save, p.est_elec_bill_save, 'NTD');
        setProgressBar('bar_water', 'txt_water', p.act_water_save, p.est_water_save, 'Ton');
        setProgressBar('bar_credit_amt', 'txt_credit_amt', p.act_carbon_credit, p.est_carbon_credit, 'Ton');
        setProgressBar('bar_credit_price', 'txt_credit_price', p.act_carbon_price, p.est_carbon_value, 'NTD');
    }

    function updateChart(chart, newData) {
        chart.data.datasets[0].data = newData;
        chart.update();
    }

    function updatePie(chart, rate) {
        let r = parseFloat(rate) || 0;
        if (r < 0) r = 0;
        if (r > 100) r = 100;
        chart.data.datasets[0].data = [r, 100 - r];
        chart.update();
    }

    function setProgressBar(barId, txtId, act, est, unit) {
        const a = parseFloat(act) || 0;
        const e = parseFloat(est) || 1;
        let pct = (a / e) * 100;
        if (pct > 100) pct = 100;

        document.getElementById(barId).style.width = `${pct}%`;
        document.getElementById(txtId).innerText = `å¯¦éš›: ${a.toLocaleString()} / é ä¼°: ${e.toLocaleString()} (${unit})`;
    }

    // å•Ÿå‹•
    init();

</script>
</body>
</html>